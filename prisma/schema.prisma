// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =========================
   ENUMS
   ========================= */
enum TipoItem {
  PRODUTO
  SERVICO
  AMBOS
}

enum FontePrecoMaterial {
  P1
  P2
  P3
}

enum FontePrecoMO {
  M1
  M2
  M3
}

enum Role {
  ADM
  USER
}

/* =========================
   CADASTROS
   ========================= */

model UnidadeMedida {
  id         Int      @id @default(autoincrement())
  usuarioId  Int
  usuario    Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  sigla      String
  nome       String

  produtos   ProdutoServico[]
  itens      EstimativaItem[] // UM sugerida/override por item

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([usuarioId, sigla])
  @@index([usuarioId])
}

model ProdutoServico {
  id              Int           @id @default(autoincrement())
  usuarioId       Int
  usuario         Usuario       @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  nome            String
  categoria       String?
  unidadeMedidaId Int
  unidade         UnidadeMedida @relation(fields: [unidadeMedidaId], references: [id])

  fornecedores    FornecedorProduto[]
  itens           EstimativaItem[]

  tipo        TipoItem @default(AMBOS)
  refPrecoP1  Decimal? @db.Decimal(12, 2)
  refPrecoP2  Decimal? @db.Decimal(12, 2)
  refPrecoP3  Decimal? @db.Decimal(12, 2)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([usuarioId, nome])
  @@index([usuarioId])
}

model Fornecedor {
  id         Int      @id @default(autoincrement())
  usuarioId  Int
  usuario    Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  nome       String
  cnpjCpf    String?
  contato    String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  produtos   FornecedorProduto[]
  itens      EstimativaItem[] @relation("FornecedorItens")

  @@unique([usuarioId, cnpjCpf])
  @@index([usuarioId, nome])
  @@index([usuarioId])
  @@unique([id, usuarioId], name: "Fornecedor_id_usuarioId_key")
}

model FornecedorProduto {
  id           Int      @id @default(autoincrement())
  usuarioId    Int
  usuario      Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  fornecedorId Int
  produtoId    Int

  fornecedor   Fornecedor     @relation(fields: [fornecedorId], references: [id], onDelete: Cascade)
  produto      ProdutoServico @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  // 3 preços Materiais
  precoMatP1   Decimal? @db.Decimal(12, 2)
  precoMatP2   Decimal? @db.Decimal(12, 2)
  precoMatP3   Decimal? @db.Decimal(12, 2)

  // 3 preços Mão de Obra
  precoMoM1    Decimal? @db.Decimal(12, 2)
  precoMoM2    Decimal? @db.Decimal(12, 2)
  precoMoM3    Decimal? @db.Decimal(12, 2)

  dataUltAtual DateTime @default(now())
  observacao   String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([usuarioId, fornecedorId, produtoId])
  @@index([usuarioId])
  @@index([fornecedorId])
  @@index([produtoId])
}

model ClienteUsuario {
  id        Int     @id @default(autoincrement())
  usuarioId Int
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  nome      String
  cpf       String?
  cnpj      String?
  email     String?
  telefone  String?
  endereco  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projetos  Projeto[]

  // Unicidade por usuário (permitindo nulls em Postgres)
  @@unique([usuarioId, cpf])
  @@unique([usuarioId, cnpj])
  @@unique([usuarioId, email])

  @@index([usuarioId, nome])
  @@index([usuarioId])
}

/* =========================
   PROJETOS & ESTIMATIVAS
   ========================= */

model Projeto {
  id         Int      @id @default(autoincrement())
  usuarioId  Int
  usuario    Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  nome       String
  status     String   @default("rascunho") // rascunho | com_estimativa | aprovado | execucao | concluido

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  clienteId  Int?
  cliente    ClienteUsuario? @relation(fields: [clienteId], references: [id], onDelete: SetNull)

  estimativas Estimativa[]
  resumo      ResumoProjeto?

  // Ajustes do Financeiro
  financeirosAjustes FinanceiroAjuste[]
  financeiroResumo   FinanceiroResumo?

  @@index([usuarioId, status])
  @@index([clienteId])
  @@index([usuarioId])
}

model Estimativa {
  id         Int      @id @default(autoincrement())
  usuarioId  Int
  usuario    Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  projetoId  Int
  projeto    Projeto  @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  nome       String   @default("Estimativa")
  criadaEm   DateTime @default(now())
  aprovada   Boolean  @default(false)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  itens      EstimativaItem[]

  @@index([usuarioId, projetoId])
  @@index([usuarioId])
}

model EstimativaItem {
  id            Int      @id @default(autoincrement())
  usuarioId     Int
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  estimativaId  Int
  estimativa    Estimativa @relation(fields: [estimativaId], references: [id], onDelete: Cascade)

  produtoId     Int
  produto       ProdutoServico @relation(fields: [produtoId], references: [id])

  quantidade    Decimal @db.Decimal(12, 3)

  unidadeId     Int
  unidade       UnidadeMedida @relation(fields: [unidadeId], references: [id])

  fornecedorId  Int
  fornecedor    Fornecedor @relation("FornecedorItens", fields: [fornecedorId], references: [id])

  fontePrecoMat FontePrecoMaterial?
  fontePrecoMo  FontePrecoMO?

  valorUnitMat  Decimal? @db.Decimal(12, 2)
  valorUnitMo   Decimal? @db.Decimal(12, 2)

  totalItem     Decimal? @db.Decimal(12, 2)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Ajustes por item (Financeiro)
  financeirosAjustes FinanceiroAjuste[]

  @@index([usuarioId, estimativaId])
  @@index([produtoId])
  @@index([unidadeId])
  @@index([fornecedorId])
  @@index([usuarioId])
}

/* =========================
   FINANCEIRO (NOVO)
   ========================= */

/**
 * Ajustes aplicados no Financeiro, SEM mudar o item original.
 * Escopos possíveis:
 *  - itemId: ajusta apenas aquela linha específica;
 *  - produtoId: ajusta todas as linhas do produto dentro do projeto;
 *  - tag: aplica por “grupo” nomeado (ex.: “Parafuso”, “Drywall”).
 *
 * percent   = variação percentual sobre o total do item (ex.: 10 = +10%, -5 = -5%)
 * valorFixo = ajuste absoluto somado ao total do item (pode ser negativo)
 *
 * Regra de cálculo (sugerida):
 *   totalAjustadoDoItem = totalItemOriginal
 *   → aplica percent (se existir)
 *   → aplica valorFixo (se existir)
 */
model FinanceiroAjuste {
  id         Int      @id @default(autoincrement())
  usuarioId  Int
  usuario    Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  projetoId  Int
  projeto    Projeto  @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  // Escopos (um OU outro OU ambos — você decide na action de gravação)
  itemId     Int?
  item       EstimativaItem? @relation(fields: [itemId], references: [id], onDelete: Cascade)

  produtoId  Int?
  produto    ProdutoServico? @relation(fields: [produtoId], references: [id])

  tag        String?   // “Parafuso”, “Drywall”, etc.

  percent    Decimal?  @db.Decimal(7, 2)   // ex.: 10.00 = +10%
  valorFixo  Decimal?  @db.Decimal(14, 2)  // pode ser negativo (desconto)

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([usuarioId])
  @@index([projetoId])
  @@index([itemId])
  @@index([produtoId])
  @@index([tag])

  // Evita duplicar ajuste de item para o mesmo projeto/usuário
  @@unique([usuarioId, projetoId, itemId], map: "uniq_financeiro_item") // itemId pode ser null → unique só vale quando não-null
}

/**
 * Resumo e configurações do Financeiro por projeto.
 * Guarda observações e a taxa global (ou % ou R$).
 */
model FinanceiroResumo {
  projetoId       Int     @id
  projeto         Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  usuarioId       Int
  usuario         Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  // Taxa global — um dos dois (ou ambos, se quiser permitir)
  taxaGlobalPct   Decimal? @db.Decimal(7, 2)   // 10.00 = +10%
  taxaGlobalValor Decimal? @db.Decimal(14, 2)  // ajuste absoluto final

  observacoes     String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([usuarioId])
}

/* =========================
   RESUMO FINANCEIRO (LEGADO)
   =========================
   Mantido para compatibilidade com sua tela atual.
   Você pode continuar usando “recebemos” aqui,
   e usar o FinanceiroResumo para taxa global/observações do PDF.
*/
model ResumoProjeto {
  projetoId   Int     @id
  projeto     Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  recebemos   Decimal @db.Decimal(14, 2)
  observacoes String?
}

/* =========================
   USUÁRIOS
   ========================= */

model Usuario {
  id             Int     @id @default(autoincrement())
  supabaseUserId String  @unique
  nome           String
  cpf            String? @unique
  email          String  @unique
  telefone       String?
  cnpj           String?
  role           Role    @default(USER)

  // relações "filhas"
  unidades       UnidadeMedida[]
  produtos       ProdutoServico[]
  fornecedores   Fornecedor[]
  vinculos       FornecedorProduto[]
  projetos       Projeto[]
  estimativas    Estimativa[]
  itens          EstimativaItem[]
  clientes       ClienteUsuario[]

  // novos relacionamentos
  financeirosAjustes FinanceiroAjuste[]
  financeirosResumo  FinanceiroResumo[]

  @@index([email])
}
