generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Usuario {
  id             Int      @id @default(autoincrement())
  supabaseUserId String   @unique
  nome           String
  cpf            String?
  email          String   @unique
  telefone       String?
  cnpj           String?
  role           Role     @default(USER)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  Categoria         Categoria[]
  ClienteUsuario    ClienteUsuario[]
  Estimativa        Estimativa[]
  EstimativaItem    EstimativaItem[]
  Fornecedor        Fornecedor[]
  FornecedorProduto FornecedorProduto[]
  ProdutoServico    ProdutoServico[]
  Projeto           Projeto[]
  UnidadeMedida     UnidadeMedida[]

  @@unique([cpf])
  @@index([email])
}

model Categoria {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  nome      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Usuario        Usuario          @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  ProdutoServico ProdutoServico[]

  @@unique([usuarioId, nome])
  @@index([usuarioId])
}

model ClienteUsuario {
  id        Int     @id @default(autoincrement())
  usuarioId Int
  nome      String
  cpf       String?
  cnpj      String?
  email     String?
  telefone  String?
  endereco  String?
  responsavel String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuario  Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  projetos Projeto[]

  @@unique([usuarioId, cpf])
  @@unique([usuarioId, cnpj])
  @@unique([usuarioId, email])
  @@index([usuarioId])
  @@index([usuarioId, nome])
}

model UnidadeMedida {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  sigla     String
  nome      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Usuario        Usuario          @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  EstimativaItem EstimativaItem[]
  ProdutoServico ProdutoServico[]

  @@unique([usuarioId, sigla])
  @@index([usuarioId])
}

model ProdutoServico {
  id              Int      @id @default(autoincrement())
  usuarioId       Int
  categoriaId     Int
  unidadeMedidaId Int
  nome            String
  tipo            TipoItem @default(AMBOS)
  refPrecoP1      Decimal? @db.Decimal(12, 2)
  refPrecoP2      Decimal? @db.Decimal(12, 2)
  refPrecoP3      Decimal? @db.Decimal(12, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  Usuario           Usuario             @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  Categoria         Categoria           @relation(fields: [categoriaId], references: [id])
  UnidadeMedida     UnidadeMedida       @relation(fields: [unidadeMedidaId], references: [id])
  EstimativaItem    EstimativaItem[]
  FornecedorProduto FornecedorProduto[]

  @@index([usuarioId])
  @@index([usuarioId, nome])
}

model Projeto {
  id        Int    @id @default(autoincrement())
  usuarioId Int
  nome      String
  status    String @default("rascunho")

  clienteId Int?
  cliente   ClienteUsuario? @relation(fields: [clienteId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuario     Usuario      @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  estimativas Estimativa[]

  // ✅ CAMPO INVERSO
  resumo ResumoProjeto?

  @@index([usuarioId])
  @@index([clienteId])
}

model Estimativa {
  id        Int @id @default(autoincrement())
  usuarioId Int
  projetoId Int

  nome     String  @default("Estimativa")
  aprovada Boolean @default(false)

  criadaEm  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  projeto Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  // ✅ CAMPO INVERSO OBRIGATÓRIO
  itens EstimativaItem[]

  @@index([usuarioId])
  @@index([projetoId])
}

model EstimativaItem {
  id            Int                 @id @default(autoincrement())
  usuarioId     Int
  estimativaId  Int
  produtoId     Int
  unidadeId     Int
  fornecedorId  Int?
  // exemplo: model EstimativaItem { ... }
  ajusteTipo    String? // "percent" | "fixo"
  ajusteValor   Decimal?            @db.Decimal(14, 2)
  quantidade    Decimal             @db.Decimal(12, 3)
  valorUnitMat  Decimal?            @db.Decimal(12, 2)
  valorUnitMo   Decimal?            @db.Decimal(12, 2)
  totalItem     Decimal?            @db.Decimal(12, 2)
  fontePrecoMat FontePrecoMaterial?
  fontePrecoMo  FontePrecoMO?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  Usuario        Usuario        @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  Estimativa     Estimativa     @relation(fields: [estimativaId], references: [id], onDelete: Cascade)
  ProdutoServico ProdutoServico @relation(fields: [produtoId], references: [id])
  UnidadeMedida  UnidadeMedida  @relation(fields: [unidadeId], references: [id])
  Fornecedor     Fornecedor?    @relation(fields: [fornecedorId], references: [id])

  @@index([usuarioId])
  @@index([estimativaId])
}

model Fornecedor {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  nome      String
  cnpjCpf   String
  contato   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Usuario           Usuario             @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  EstimativaItem    EstimativaItem[]
  FornecedorProduto FornecedorProduto[]

  @@unique([usuarioId, cnpjCpf])
  @@index([usuarioId])
}

model FornecedorProduto {
  id           Int      @id @default(autoincrement())
  usuarioId    Int
  fornecedorId Int
  produtoId    Int
  precoMatP1   Decimal? @db.Decimal(12, 2)
  precoMatP2   Decimal? @db.Decimal(12, 2)
  precoMatP3   Decimal? @db.Decimal(12, 2)
  precoMoM1    Decimal? @db.Decimal(12, 2)
  precoMoM2    Decimal? @db.Decimal(12, 2)
  precoMoM3    Decimal? @db.Decimal(12, 2)
  observacao   String?
  dataUltAtual DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  Usuario        Usuario        @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  Fornecedor     Fornecedor     @relation(fields: [fornecedorId], references: [id], onDelete: Cascade)
  ProdutoServico ProdutoServico @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, fornecedorId, produtoId])
}

model ResumoProjeto {
  projetoId   Int     @id
  recebemos   Decimal @db.Decimal(14, 2)
  observacoes String?

  Projeto Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)
}

enum Role {
  ADM
  USER
}

enum TipoItem {
  PRODUTO
  SERVICO
  AMBOS
}

enum FontePrecoMO {
  M1
  M2
  M3
  MANUAL
}

enum FontePrecoMaterial {
  P1
  P2
  P3
  MANUAL
}
